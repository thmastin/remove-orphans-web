<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reorder Estimate Templates by Folder Name</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; background: var(--bg, #fff); color: var(--fg, #222); }
        .container { max-width: 600px; margin: auto; }
        input[type="file"] { margin-bottom: 1em; }
        button { margin-top: 1em; }
        #download { display: none; margin-top: 1em; }
        .dark-toggle { float: right; margin-top: -2.5em; }
        @media (prefers-color-scheme: dark) {
            body { --bg: #181a1b; --fg: #eee; }
        }
        body.dark-mode { --bg: #181a1b; --fg: #eee; }
    </style>
</head>
<body>
<div class="container">
    <button class="dark-toggle" onclick="toggleDarkMode()">Toggle Dark Mode</button>
    <h2>Reorder Estimate Templates by Folder Name</h2>
    <div style="margin-bottom:2em;">
        <input type="file" id="csvFile" accept=".csv" />
        <button onclick="processCSV()">Process CSV</button>
        <a id="download" download="reordered_templates.csv">Download Reordered CSV</a>
        <div id="status"></div>
    </div>
    <div class="desc">This tool reorders estimate template CSVs so that each template (grouped by rows starting with a non-empty <b>folder_name</b> column) is sorted alphabetically by the <b>folder_name</b> value (using the first value if comma-separated).</div>
    <a href="../index.html">&larr; Back to Tool Index</a>
</div>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
}
if (localStorage.getItem('darkMode') === 'true') {
    document.body.classList.add('dark-mode');
}

function processCSV() {
    const fileInput = document.getElementById('csvFile');
    const status = document.getElementById('status');
    const download = document.getElementById('download');
    if (!fileInput.files.length) {
        status.textContent = 'Please select a CSV file.';
        return;
    }
    status.textContent = 'Processing...';
    const originalName = fileInput.files[0].name;
    const outputName = originalName.replace(/(\.csv)?$/i, '_reordered.csv');
    Papa.parse(fileInput.files[0], {
        header: true,
        skipEmptyLines: false,
        complete: function(results) {
            const headers = results.meta.fields;
            const data = results.data;
            // Group rows into templates
            let templates = [];
            let current = [];
            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                if (row['folder_name'] && row['folder_name'].trim() !== '') {
                    if (current.length) templates.push(current);
                    current = [row];
                } else {
                    if (current.length) current.push(row);
                }
            }
            if (current.length) templates.push(current);
            // Sort templates by the full folder_name (file tree order, case-insensitive)
            templates.sort((a, b) => {
                const aName = a[0]['folder_name'] ? a[0]['folder_name'].trim().toLowerCase() : '';
                const bName = b[0]['folder_name'] ? b[0]['folder_name'].trim().toLowerCase() : '';
                return aName.localeCompare(bName);
            });
            // Flatten back to rows
            const reordered = templates.flat();
            const csvReordered = Papa.unparse(reordered, { columns: headers });
            const blob = new Blob([csvReordered], { type: 'text/csv' });
            download.href = URL.createObjectURL(blob);
            download.download = outputName;
            download.style.display = 'inline';
            status.innerHTML = `Done! Templates reordered by folder_name.<br>Download: <b>${outputName}</b>`;
        },
        error: function(err) {
            status.textContent = 'Error: ' + err.message;
        }
    });
}
</script>
</body>
</html>
